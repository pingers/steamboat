<?php

namespace SteamBoat\SteamBoatBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Mapping\ClassMetadata;

/**
 * SteamIdStorageRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class SteamIdStorageRepository extends EntityRepository
{

/**
 * Retrieve a SteamId by Nickname. Fetches friends.
 *
 * @param $nickname
 * @return object|null
 */
    public function findOneByNickname($nickname) {
        // Check local cache.
        $steamIdStorage = $this->findOneBy(array('nickname' => $nickname));

        return $steamIdStorage ?: null;
    }

/**
 * Retrieve a SteamId by SteamId64. Does not fetch friends by default.
 *
 * @param $steamId64
 * @return object|null
 */
    public function findOneBySteamId64($steamId64) {
        // Check local cache.
        $steamIdStorage = $this->findOneBy(array('steamId64' => $steamId64));

        return $steamIdStorage ?: null;
    }

    /**
     * @param $steamId
     * @param $fetchFriends
     * @return object|null
     */
    public function createSteamIdStorage($steamIdData, $fetchFriends = FALSE) {
        $entityManager = $this->getEntityManager();

        $relatedEntities = [
            'Friends',
            'Games',
        ];

        // Map the entity properties.
        $steamIdStorage = new SteamIdStorage();

        // Handle regular properties and related entities.
        foreach ($steamIdData as $property => $value) {
            if (in_array($property, $relatedEntities)) {
                $this->{'add' . $property}($steamIdStorage, $value);
            }
            else {
                $steamIdStorage->{'set' . $property}($value);
            }
        }

        $entityManager->persist($steamIdStorage);
        return $steamIdStorage;
    }

    /**
     * @param $steamIdStorage
     * @return object|null
     */
    public function writeSteamIdStorage($steamIdStorage) {
        // Cache the steamId in the database.
        $entityManager = $this->getEntityManager();
        $entityManager->flush();
        return $steamIdStorage;
    }

    /**
     * @param $steamIdStorage
     * @param $games
     * @return object|null
     */
    public function addGames(&$steamIdStorage, $games) {
        $entityManager = $this->getEntityManager();

        // Map games.
        $gameEntityManager = $entityManager->getRepository('SteamBoatBundle:SteamGameStorage');
        if ($games) {
            foreach ($games as $game) {
                // Check for existing game.
                // @TODO Use array.
                if ($existingGame = $gameEntityManager->findOneByAppId($game['AppId'])) {
                    $steamIdStorage->addGame($existingGame);
                }
                else {
                    $steamIdStorage->addGame($gameEntityManager->createSteamGameStorage($game));
                }
            }
        }

        return $steamIdStorage;
    }

    /**
     * @param $steamIdStorage
     * @param $friends
     * @return object|null
     */
    public function addFriends(&$steamIdStorage, $friends) {
        $entityManager = $this->getEntityManager();

        // Map games.
        $SteamIdEm = $entityManager->getRepository('SteamBoatBundle:SteamIdStorage');
        if ($friends) {
            foreach ($friends as $friend) {
                // Check if we already know about this friend.
//                if ($existingId = $SteamIdEm->findOneBySteamId64($friend->getId())) {
//                    $steamIdStorage->addFriend($existingId);
//                }
//                else {
//                    $steamIdStorage->addFriend($SteamIdEm->createSteamIdStorage($friend));
//                }
            }
        }
        return $steamIdStorage;
    }
}
